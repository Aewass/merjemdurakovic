---
import Layout from '../layouts/Layout.astro';
import Footer from './Footer.astro';
import { ArrowLeft, Maximize2, ChevronLeft, ChevronRight, X } from 'lucide-astro';
import { getLangFromUrl, useTranslations, useTranslatedPath } from '../i18n/utils';

import type { CatalogItem, CatalogImage } from '../types/category';
import { 
  getBackgroundClass, 
  getHoverClass, 
  getTextClass, 
  getTitleClass,
  getBadgeBgClass, 
  getBadgeDotClass, 
  getFullscreenClass, 
  getNavigationClass,
  isBrandingLayout,
  isSocialMediaLayout
} from '../utils/categoryColors';

interface Props {
  id: string;
  category: {
    number: string;
    title: string;
    category: string;
    description: string;
    items: CatalogItem[];
  };
}

const { id, category } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

// Map subcategories to their parent main categories
const categoryToMainCategoryMap: Record<string, string> = {
  // 3D categories
  '3d-medieval-man': '3d-character',
  '3d-facial-anatomy': '3d-character',
  
  // 2D Design categories
  'branding-ac-mint': '2d-design',
  'branding-shams-travel': '2d-design',
  'branding-upscale': '2d-design',
  'branding-pumpkin': '2d-design',
  'catalogs': '2d-design',
  'visit-cards': '2d-design',
  'books': '2d-design',
  'print-media': '2d-design',
  'social-media': '2d-design',
};

// Determine back link based on category mapping
const parentCategory = categoryToMainCategoryMap[id];
const backLink = parentCategory 
  ? translatePath(`/main-category/${parentCategory}`)
  : translatePath('/#main-categories');
const backText = parentCategory 
  ? t('main_category.back_to_category')
  : t('main_category.back_to_home');
---

<Layout title={`${category.title} - ${category.category}`}>
  <main class="relative min-h-screen">
    <div class="fixed inset-0">
            <div class={`absolute inset-0 bg-[radial-gradient(circle_at_top,_var(--tw-gradient-stops))] ${getBackgroundClass(id)}`}></div>
    </div>

    <div class="relative">
      <article class="pt-24 pb-24">
        <div class="max-w-6xl mx-auto px-6 sm:px-8">
          <!-- Back Button -->
          <a 
            href={backLink} 
            class={`
              inline-flex 
              items-center 
              gap-2 
              text-gray-500 
              ${getHoverClass(id)}
              transition-colors 
              duration-300 
              mb-12 
              group
            `}
          >
            <ArrowLeft class="w-4 h-4 group-hover:-translate-x-1 transition-transform duration-300" />
            <span class="text-sm">{backText}</span>
          </a>

          <!-- Catalogs List -->
          <div class="space-y-40">
            {category.items.map((item: CatalogItem, itemIndex: number) => (
              <div class="catalog-item">
                <!-- Text Section -->
                <div class="mb-12">
                  <h2 class={`text-4xl font-bold mb-4 ${getTitleClass(id)}`}>{item.name}</h2>
                  <div class="flex items-center">
                    <span class={`inline-flex items-center py-1.5 px-3 ${getBadgeBgClass(id)} text-sm text-gray-800 rounded-full`}>
                      <span class={`w-1.5 h-1.5 ${getBadgeDotClass(id)} rounded-full mr-2`}></span>
                      {item.images.length} {
                        item.images.length === 1 
                          ? t('category.image') 
                          : t('category.images')
                      }
                    </span>
                  </div>
                </div>
                
                <!-- Swiper Carousel OR Social Media Grid OR Branding Vertical Layout -->
                {isBrandingLayout(id) ? (
                  <!-- Branding Vertical Stack Layout -->
                  <div class="branding-vertical-stack">
                    {item.images.map((image: CatalogImage, index: number) => (
                      <div class="branding-image-container">
                        <div class="relative">
                          {image.type === 'video' ? (
                            <video 
                              src={image.src} 
                              class={`w-full h-auto object-contain ${
                                index === 0 ? 'rounded-t-2xl' : 
                                index === item.images.length - 1 ? 'rounded-b-2xl' : 
                                'rounded-none'
                              }`}
                              controls
                              autoplay
                              muted
                              loop
                              playsinline
                              data-fullview={image.src}
                              data-type="video"
                            ></video>
                          ) : (
                            <img 
                              src={image.src} 
                              alt={image.alt || `${item.name} image ${index + 1}`}
                              loading={index === 0 ? "eager" : "lazy"}
                              decoding="async"
                              fetchpriority={index === 0 ? "high" : "auto"}
                              class={`w-full h-auto object-contain ${
                                index === 0 ? 'rounded-t-2xl' : 
                                index === item.images.length - 1 ? 'rounded-b-2xl' : 
                                'rounded-none'
                              }`}
                              data-fullview={image.src}
                              data-type="image"
                            />
                          )}
                          
                          {/* Fullscreen button */}
                          <button 
                            class="fullscreen-btn absolute top-4 right-4 bg-white/95 backdrop-filter backdrop-blur-sm p-2.5 rounded-full shadow-lg opacity-0 hover:opacity-100 transition-all duration-300 ease-out hover:bg-white hover:scale-105 hover:shadow-xl z-10"
                            data-fullview={image.src}
                            data-alt={image.alt}
                            data-type={image.type || 'image'}
                          >
                            <Maximize2 class={`w-5 h-5 ${getFullscreenClass(id)}`} />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : isSocialMediaLayout(id) ? (
                  <!-- Social Media Grid Layout (Desktop) / Slider (Mobile/Tablet) -->
                  <div class="social-media-container">
                    <!-- Desktop Grid -->
                    <div class={`social-media-grid images-${Math.min(item.images.length, 5)} hidden lg:grid`}>
                      {item.images.slice(0, 5).map((image: CatalogImage, index: number) => (
                        <div class={`grid-item item-${index + 1}`}>
                          <div class="relative w-full h-full group cursor-pointer overflow-hidden rounded-2xl">
                            <img 
                              src={image.src} 
                              alt={image.alt || `${item.name} image ${index + 1}`}
                              loading={index === 0 ? "eager" : "lazy"}
                              decoding="async"
                              fetchpriority={index === 0 ? "high" : "auto"}
                              class="w-full h-full object-cover transition-all duration-500 ease-out group-hover:scale-[1.02]"
                              data-fullview={image.src}
                            />
                            
                            {/* Subtle hover overlay */}
                            <div class="absolute inset-0 bg-black/0 transition-all duration-500 ease-out group-hover:bg-black/5 rounded-2xl"></div>
                            
                            {/* Fullscreen button */}
                            <button 
                              class="fullscreen-btn absolute top-3 right-3 bg-white/90 backdrop-filter backdrop-blur-sm p-2 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-all duration-300 ease-out hover:bg-white hover:scale-105 hover:shadow-xl z-10"
                              data-fullview={image.src}
                              data-alt={image.alt}
                            >
                              <Maximize2 class="w-4 h-4 text-cyan-600" />
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                    
                    <!-- Mobile/Tablet Slider -->
                    <div class={`category-swiper-${itemIndex} relative lg:hidden`}>
                      <div class="swiper-container relative rounded-2xl overflow-hidden">
                        <div class="swiper-wrapper">
                          {item.images.map((image: CatalogImage, index: number) => (
                            <div class="swiper-slide">
                              <div class="relative w-full group cursor-pointer">
                                <img 
                                  src={image.src} 
                                  alt={image.alt || `${item.name} image ${index + 1}`}
                                  loading={index === 0 ? "eager" : "lazy"}
                                  decoding="async"
                                  fetchpriority={index === 0 ? "high" : "auto"}
                                  class="w-full h-auto object-contain rounded-2xl transition-all duration-500 ease-out group-hover:scale-[1.02]"
                                  data-fullview={image.src}
                                />
                                
                                {/* Controls float over the image */}
                                <div class="absolute inset-0 bg-black/0 transition-all duration-500 ease-out group-hover:bg-black/5 rounded-2xl"></div>
                                
                                {/* Fullscreen button */}
                                <button 
                                  class="fullscreen-btn absolute top-4 right-4 bg-white/90 backdrop-filter backdrop-blur-sm p-2.5 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-all duration-300 ease-out hover:bg-white hover:scale-105 hover:shadow-xl z-10"
                                  data-fullview={image.src}
                                  data-alt={image.alt}
                                >
                                  <Maximize2 class="w-5 h-5 text-cyan-600" />
                                </button>
                              </div>
                            </div>
                          ))}
                        </div>
                        
                        {/* Navigation buttons - only show if more than 1 image */}
                        {item.images.length > 1 && (
                          <>
                            <button class={`swiper-button-prev category-nav-btn category-nav-prev-${itemIndex}`}>
                              <ChevronLeft class="w-7 h-7 text-cyan-600" />
                            </button>
                            <button class={`swiper-button-next category-nav-btn category-nav-next-${itemIndex}`}>
                              <ChevronRight class="w-7 h-7 text-cyan-600" />
                            </button>
                          </>
                        )}
                      </div>

                    </div>
                  </div>
                ) : (
                  <!-- Original Swiper Carousel for other categories -->
                  <div class={`category-swiper-${itemIndex} relative`}>
                    <div class="swiper-container relative rounded-2xl overflow-hidden">
                      <div class="swiper-wrapper">
                        {item.images.map((image: CatalogImage, index: number) => (
                          <div class="swiper-slide">
                            <div class="relative w-full group cursor-pointer">
                              <img 
                                src={image.src} 
                                alt={image.alt || `${item.name} image ${index + 1}`}
                                loading={index === 0 ? "eager" : "lazy"}
                                decoding="async"
                                fetchpriority={index === 0 ? "high" : "auto"}
                                class="w-full h-auto object-contain rounded-2xl transition-all duration-500 ease-out group-hover:scale-[1.02]"
                                data-fullview={image.src}
                              />
                              
                              {/* Controls float over the image */}
                              <div class="absolute inset-0 bg-black/0 transition-all duration-500 ease-out group-hover:bg-black/5 rounded-2xl"></div>
                              
                              {/* Fullscreen button */}
                              <button 
                                class="fullscreen-btn absolute top-4 right-4 bg-white/90 backdrop-filter backdrop-blur-sm p-2.5 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-all duration-300 ease-out hover:bg-white hover:scale-105 hover:shadow-xl z-10"
                                data-fullview={image.src}
                                data-alt={image.alt}
                              >
                                <Maximize2 class={`w-5 h-5 ${getFullscreenClass(id)}`} />
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                      
                      {/* Navigation buttons positioned over the image */}
                      {item.images.length > 1 && (
                        <>
                          <button class={`swiper-button-prev category-nav-btn category-nav-prev-${itemIndex}`}>
                            <ChevronLeft class={`w-7 h-7 ${getNavigationClass(id)}`} />
                          </button>
                          <button class={`swiper-button-next category-nav-btn category-nav-next-${itemIndex}`}>
                            <ChevronRight class={`w-7 h-7 ${getNavigationClass(id)}`} />
                          </button>
                        </>
                      )}

                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      </article>

      <!-- Full-size image viewer -->
      <div id="imageViewer" class="fixed inset-0 bg-black z-50 hidden flex items-center justify-center">
        <button id="closeViewer" class="absolute top-6 right-6 text-white hover:text-gray-300">
          <X class="w-8 h-8" />
        </button>
        <button id="prevImage" class="absolute left-4 md:left-6 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 bg-black/50 hover:bg-black/70 p-3 rounded-full transition-all z-10">
          <ChevronLeft class="w-8 h-8 md:w-10 md:h-10" />
        </button>
        <img id="fullImage" src="" alt="Full size image" class="max-h-[90vh] max-w-[90vw] object-contain" />
        <video id="fullVideo" class="max-h-[90vh] max-w-[90vw] object-contain hidden" controls autoplay playsinline loop></video>
        <button id="nextImage" class="absolute right-4 md:right-6 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 bg-black/50 hover:bg-black/70 p-3 rounded-full transition-all z-10">
          <ChevronRight class="w-8 h-8 md:w-10 md:h-10" />
        </button>
      </div>

      <Footer />
    </div>
  </main>
</Layout>

<style>
  /* Branding Vertical Stack Layout */
  .branding-vertical-stack {
    width: 100%;
  }

  .branding-image-container {
    margin: 0;
  }

  .branding-image-container img {
    display: block;
    margin: 0;
  }

  /* Show fullscreen button on hover over the container */
  .branding-image-container:hover .fullscreen-btn {
    opacity: 1 !important;
  }

  /* Mobile responsive for branding */
  @media (max-width: 768px) {
    .branding-vertical-stack {
      gap: 1.5rem;
    }
    
    .branding-image-container img {
      max-height: 60vh !important;
    }
    
    .branding-image-container .fullscreen-btn {
      top: 12px !important;
      right: 12px !important;
      padding: 8px !important;
    }
    
    .branding-image-container .fullscreen-btn .lucide {
      width: 18px !important;
      height: 18px !important;
    }
  }

  /* Social Media Grid Layout - only on desktop */
  @media (min-width: 1024px) {
    .social-media-grid {
      display: grid;
      gap: 16px;
      width: 100%;
      min-height: 500px;
    }
  }

  /* Grid layouts - exactly like the reference image */
  .social-media-grid.images-1 {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr;
  }

  .social-media-grid.images-2 {
    grid-template-columns: 2fr 1fr;
    grid-template-rows: 1fr;
  }

  .social-media-grid.images-3 {
    grid-template-columns: 2fr 1fr;
    grid-template-rows: 1fr 1fr;
  }

  .social-media-grid.images-4 {
    grid-template-columns: 2fr 1fr 1fr;
    grid-template-rows: 1fr 1fr;
  }

  .social-media-grid.images-5 {
    grid-template-columns: 2fr 1fr 1fr;
    grid-template-rows: 1fr 1fr;
  }

  /* Grid item positioning */
  .grid-item {
    background: transparent;
  }

  /* First item is always large - spans full height */
  .images-2 .item-1,
  .images-3 .item-1,
  .images-4 .item-1,
  .images-5 .item-1 {
    grid-column: 1;
    grid-row: 1 / -1;
  }

  /* Two images layout */
  .images-2 .item-2 {
    grid-column: 2;
    grid-row: 1;
  }

  /* Three images layout */
  .images-3 .item-2 {
    grid-column: 2;
    grid-row: 1;
  }

  .images-3 .item-3 {
    grid-column: 2;
    grid-row: 2;
  }

  /* Four images layout - 2x2 grid on the right */
  .images-4 .item-2 {
    grid-column: 2;
    grid-row: 1;
  }

  .images-4 .item-3 {
    grid-column: 3;
    grid-row: 1;
  }

  .images-4 .item-4 {
    grid-column: 2;
    grid-row: 2;
  }

  /* Five images layout - 2x2 grid on the right */
  .images-5 .item-2 {
    grid-column: 2;
    grid-row: 1;
  }

  .images-5 .item-3 {
    grid-column: 3;
    grid-row: 1;
  }

  .images-5 .item-4 {
    grid-column: 2;
    grid-row: 2;
  }

  .images-5 .item-5 {
    grid-column: 3;
    grid-row: 2;
  }

  /* Mobile responsive - only applies when grid is visible (desktop) */
  @media (min-width: 1024px) and (max-width: 768px) {
    /* This media query will never match, effectively disabling mobile grid styles */
  }

    /* Swiper Container */
  .swiper-container {
    width: 100%;
  }

  .swiper-slide {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    background: transparent;
  }

  .swiper-slide img {
    transition: transform 0.5s ease-out, filter 0.3s ease-out;
    will-change: transform;
  }

  /* Navigation buttons */
  .category-nav-btn {
    position: absolute !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    width: 60px !important;
    height: 60px !important;
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(16px) !important;
    border: none !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    cursor: pointer !important;
    z-index: 20 !important;
    opacity: 1 !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
    will-change: transform, opacity !important;
  }

  .category-nav-btn[class*="prev"] {
    left: 24px !important;
  }

  .category-nav-btn[class*="next"] {
    right: 24px !important;
  }

  .category-nav-btn:hover {
    background: rgba(255, 255, 255, 1) !important;
    transform: translateY(-50%) scale(1.05) !important;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.16) !important;
  }

  .category-nav-btn:active {
    transform: translateY(-50%) scale(0.95) !important;
  }

  /* Remove default swiper button styles */
  .swiper-button-prev:after,
  .swiper-button-next:after {
    display: none !important;
  }



  /* Touch/mobile improvements */
  @media (max-width: 768px) {
    .category-nav-btn {
      opacity: 1 !important;
      width: 40px !important;
      height: 40px !important;
    }
    
    .swiper-pagination {
      opacity: 1;
    }

    .swiper-container {
      border-radius: 0.75rem;
    }
  }

  /* Image loading styles */
  .loading-indicator {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #f3f4f6;
    z-index: 1;
    overflow: hidden;
  }
  
  .loading-indicator::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
    animation: shimmer 1.5s infinite;
    transform: translateX(-100%);
  }

  img {
    opacity: 0;
    transition: opacity 0.3s ease;
    position: relative;
    z-index: 2;
  }

  img.loaded {
    opacity: 1;
  }

  @keyframes shimmer {
    100% {
      transform: translateX(100%);
    }
  }

  #fullImage {
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  #fullImage.loaded {
    opacity: 1;
  }
</style>

<script>
  import Swiper from 'swiper';
  import { Navigation, Pagination, Autoplay } from 'swiper/modules';
  import 'swiper/css';
  import 'swiper/css/navigation';
  import 'swiper/css/pagination';
  import { preloadImage, getCachedImage } from '../utils/imageCache';

  // Color mapping for pagination
  const colorMap: Record<string, string> = {
    'visit-cards': '#e11d48',
    'books': '#059669', 
    'print-media': '#d97706',
    'branding': '#4f46e5',
    'social-media': '#0891b2',
    'catalogs': '#9333ea'
  };

  // Get current category from URL
  const categoryId = window.location.pathname.split('/').pop() || 'catalogs';
  const currentColor = colorMap[categoryId] || '#9333ea';

  document.addEventListener('DOMContentLoaded', () => {
    // Setup image loading and click handlers first
    setupImageLoading();
    setupFullscreenHandlers();

    // Initialize all Swiper instances
    const swiperContainers = document.querySelectorAll('.swiper-container');
    
    swiperContainers.forEach((container, index) => {
      const swiper = new Swiper(container as HTMLElement, {
        modules: [Navigation, Pagination, Autoplay],
        slidesPerView: 1,
        spaceBetween: 0,
        grabCursor: true,
        touchRatio: 1,
        resistance: true,
        resistanceRatio: 0.85,
        loop: container.querySelectorAll('.swiper-slide').length > 1,
        speed: 600,
        autoplay: container.querySelectorAll('.swiper-slide').length > 1 ? {
          delay: 5000,
          disableOnInteraction: false,
          pauseOnMouseEnter: true,
        } : false,
        navigation: {
          nextEl: container.querySelector(`.category-nav-next-${index}`) as HTMLElement,
          prevEl: container.querySelector(`.category-nav-prev-${index}`) as HTMLElement,
        },
        pagination: {
          el: document.querySelector(`.pagination-${categoryId}-${index}`) as HTMLElement,
          clickable: true,
          dynamicBullets: false,
        },
        on: {
          init: function() {
            // Apply colors after initialization
            setTimeout(() => {
              const bullets = container.querySelectorAll('.swiper-pagination-bullet');
              bullets.forEach((bullet: Element) => {
                const htmlBullet = bullet as HTMLElement;
                if (htmlBullet.classList.contains('swiper-pagination-bullet-active')) {
                  htmlBullet.style.backgroundColor = currentColor;
                  htmlBullet.style.borderColor = currentColor;
                }
              });
            }, 100);
          },
          slideChange: function() {
            // Reapply colors on slide change
            const bullets = container.querySelectorAll('.swiper-pagination-bullet');
            bullets.forEach((bullet: Element) => {
              const htmlBullet = bullet as HTMLElement;
              if (htmlBullet.classList.contains('swiper-pagination-bullet-active')) {
                htmlBullet.style.backgroundColor = currentColor;
                htmlBullet.style.borderColor = currentColor;
              } else {
                htmlBullet.style.backgroundColor = 'rgba(255, 255, 255, 0.6)';
                htmlBullet.style.borderColor = 'rgba(255, 255, 255, 0.8)';
              }
            });
          }
        }
      });
    });
  });

  // Setup image loading and click handlers
  function setupImageLoading() {
    document.querySelectorAll('img[data-fullview]').forEach(img => {
      // Create and add loading indicator
      const parent = img.parentElement;
      if (parent && !parent.querySelector('.loading-indicator')) {
        // Add a loading indicator div
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading-indicator';
        parent.appendChild(loadingDiv);
        
        // Handler to remove loading indicator
        const removeLoading = () => {
          img.classList.add('loaded');
          loadingDiv.remove();
        };
        
        // Add load event to remove loading state
        img.addEventListener('load', removeLoading);
        
        // For already loaded images
        if ((img as HTMLImageElement).complete) {
          removeLoading();
        }
      }
    });
  }

  // Initialize image viewers for all images with data-fullview
  let currentImages: string[] = [];
  let currentIndex = 0;
  
  // Setup touch variables
  let touchStartX = 0;
  let touchEndX = 0;
  
  // Handle swipe direction
  function handleSwipe() {
    const viewer = document.getElementById('imageViewer');
    if (viewer && !viewer.classList.contains('hidden') && currentImages.length > 1) {
      const swipeThreshold = 50;
      const swipeDistance = touchEndX - touchStartX;
      
      if (swipeDistance < -swipeThreshold) {
        currentIndex = (currentIndex + 1) % currentImages.length;
        updateViewerImage();
      } else if (swipeDistance > swipeThreshold) {
        currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
        updateViewerImage();
      }
    }
  }
  
  // Setup touch events for fullscreen navigation
  function setupTouchEvents() {
    const fullImage = document.getElementById('fullImage');
    if (fullImage) {
      fullImage.removeEventListener('touchstart', handleTouchStart);
      fullImage.removeEventListener('touchend', handleTouchEnd);
      
      fullImage.addEventListener('touchstart', handleTouchStart, { passive: true });
      fullImage.addEventListener('touchend', handleTouchEnd, { passive: true });
    }
  }
  
  // Touch event handlers
  function handleTouchStart(e: TouchEvent) {
    touchStartX = e.changedTouches[0].screenX;
  }
  
  function handleTouchEnd(e: TouchEvent) {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  }

  // Setup click handlers for both images and fullscreen buttons
  function setupFullscreenHandlers() {
    document.querySelectorAll('img[data-fullview]').forEach(img => {
      img.addEventListener('click', () => {
        openFullscreenViewer(img as HTMLImageElement);
      });
    });

    document.querySelectorAll('.fullscreen-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const container = btn.closest('.group, .relative');
        if (container) {
          const media = container.querySelector('[data-fullview]') as HTMLElement;
          if (media) {
            openFullscreenViewer(media);
          }
        }
      });
    });
  }

  // Function to open fullscreen viewer
  function openFullscreenViewer(element: HTMLElement) {
    const fullview = element.getAttribute('data-fullview');
    const viewer = document.getElementById('imageViewer');
    const fullImage = document.getElementById('fullImage') as HTMLImageElement;
    const fullVideo = document.getElementById('fullVideo') as HTMLVideoElement;
    
    if (fullview && viewer && fullImage && fullVideo) {
      // Find the container that contains this image
      const swiperContainer = element.closest('[class*="category-swiper"]');
      const brandingContainer = element.closest('.branding-vertical-stack');
      const socialGridContainer = element.closest('.social-media-grid');
      const socialContainer = element.closest('.social-media-container');
      
      currentImages = [];
      
      const collectMedia = (container: Element) => {
        container.querySelectorAll('[data-fullview]').forEach(item => {
          const src = item.getAttribute('data-fullview');
          if (src) {
             // Avoid duplicates (video element + button might both be found)
             if (!currentImages.includes(src)) {
               currentImages.push(src);
             }
          }
        });
      };

      if (swiperContainer) {
        collectMedia(swiperContainer);
      } else if (brandingContainer) {
        collectMedia(brandingContainer);
      } else if (socialGridContainer) {
        collectMedia(socialGridContainer);
      } else if (socialContainer) {
        const isDesktop = window.innerWidth >= 1024;
        const targetContainer = isDesktop 
          ? socialContainer.querySelector('.social-media-grid')
          : socialContainer.querySelector('[class*="category-swiper"]');
        
        if (targetContainer) {
          collectMedia(targetContainer);
        }
      } else {
        const catalogItem = element.closest('.catalog-item');
        if (catalogItem) {
          collectMedia(catalogItem);
        }
      }
      
      currentIndex = currentImages.indexOf(fullview);
      
      updateViewerImage();
      
      viewer.classList.remove('hidden');
      viewer.classList.add('flex');
      
      document.body.style.overflow = 'hidden';

      const prevButton = document.getElementById('prevImage');
      const nextButton = document.getElementById('nextImage');
      if (prevButton && nextButton) {
        if (currentImages.length <= 1) {
          prevButton.style.display = 'none';
          nextButton.style.display = 'none';
        } else {
          prevButton.style.display = '';
          nextButton.style.display = '';
        }
      }
    }
  }

  // Function to update the viewer image based on current index
  async function updateViewerImage() {
    const fullImage = document.getElementById('fullImage') as HTMLImageElement;
    const fullVideo = document.getElementById('fullVideo') as HTMLVideoElement;
    const currentSrc = currentImages[currentIndex];
    
    if (currentSrc) {
      const isVideo = currentSrc.toLowerCase().endsWith('.mp4') || 
                     currentSrc.toLowerCase().endsWith('.webm') || 
                     currentSrc.toLowerCase().endsWith('.mov');

      if (isVideo) {
        fullImage.classList.add('hidden');
        fullVideo.classList.remove('hidden');
        fullVideo.src = currentSrc;
        // Reset and play
        fullVideo.currentTime = 0;
        fullVideo.play().catch(e => console.log('Autoplay failed', e));
      } else {
        fullVideo.classList.add('hidden');
        fullVideo.pause();
        fullImage.classList.remove('hidden');
        fullImage.classList.remove('loaded');
        
        const cachedResponse = await getCachedImage(currentSrc);
        if (cachedResponse) {
          const blob = await cachedResponse.blob();
          const objectUrl = URL.createObjectURL(blob);
          fullImage.src = objectUrl;
          fullImage.classList.add('loaded');
          fullImage.onload = () => {
            URL.revokeObjectURL(objectUrl);
            preloadAdjacentImages();
          };
        } else {
          fullImage.src = currentSrc;
          fullImage.onload = async () => {
            fullImage.classList.add('loaded');
            preloadAdjacentImages();
          };
        }
      }
      
      // Update alt text for image
      if (!isVideo) {
        // Find the original image/element to get its alt text
        const originalElement = document.querySelector(`[data-fullview="${currentSrc}"]`);
        if (originalElement) {
          const alt = originalElement.getAttribute('alt') || originalElement.getAttribute('data-alt') || '';
          fullImage.alt = alt;
        }
      }
    }
  }

  // Function to preload only adjacent images (more conservative)
  async function preloadAdjacentImages() {
    if (currentImages.length <= 1) return;
    
    const nextIndex = (currentIndex + 1) % currentImages.length;
    const prevIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
    
    // Only preload if not already cached to avoid unnecessary network requests
    const preloadPromises = [];
    
    if (nextIndex !== currentIndex) {
      preloadPromises.push(preloadImage(currentImages[nextIndex]));
    }
    
    if (prevIndex !== currentIndex && prevIndex !== nextIndex) {
      preloadPromises.push(preloadImage(currentImages[prevIndex]));
    }
    
    await Promise.all(preloadPromises);
  }

  // Setup navigation handlers
  document.getElementById('prevImage')?.addEventListener('click', () => {
    if (currentImages.length > 1) {
      currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
      updateViewerImage();
    }
  });
  
  document.getElementById('nextImage')?.addEventListener('click', () => {
    if (currentImages.length > 1) {
      currentIndex = (currentIndex + 1) % currentImages.length;
      updateViewerImage();
    }
  });
  
  // Close viewer
  document.getElementById('closeViewer')?.addEventListener('click', () => {
    const viewer = document.getElementById('imageViewer');
    if (viewer) {
      viewer.classList.add('hidden');
      viewer.classList.remove('flex');
      document.body.style.overflow = '';
    }
  });
  
  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    const viewer = document.getElementById('imageViewer');
    if (viewer && !viewer.classList.contains('hidden')) {
      if (e.key === 'Escape') {
        viewer.classList.add('hidden');
        viewer.classList.remove('flex');
        document.body.style.overflow = '';
      } else if (e.key === 'ArrowLeft') {
        if (currentImages.length > 1) {
          currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
          updateViewerImage();
        }
      } else if (e.key === 'ArrowRight') {
        if (currentImages.length > 1) {
          currentIndex = (currentIndex + 1) % currentImages.length;
          updateViewerImage();
        }
      }
    }
  });

  // Initial setup - moved to DOMContentLoaded
</script>
